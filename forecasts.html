<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WxLaunch Forecasts</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#0b132b,#1c2541,#3a506b);
  color: white;
}

header {
  padding: 16px 24px;
  font-size: 22px;
  font-weight: bold;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

.card {
  background: rgba(255,255,255,0.05);
  border-radius: 14px;
  padding: 20px;
  backdrop-filter: blur(8px);
}

.controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 16px;
}

select, button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
}

button {
  cursor: pointer;
  background: #3a86ff;
  color: white;
}

button.arrow {
  font-size: 20px;
  padding: 6px 14px;
  background: #1f4068;
}

.slider-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.slider-row span {
  min-width: 120px;
  font-weight: bold;
}

input[type=range] {
  flex: 1;
}

.valid-label {
  text-align: right;
  margin-top: 4px;
  font-size: 14px;
  opacity: 0.9;
}

img {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>

<header>WxLaunch Forecasts</header>

<div class="container">
  <div class="card">

    <div class="controls">
      <label>Variable:</label>

      <select id="varSelect">
        <option value="maxt">Max Temp (°F)</option>
        <option value="mint">Min Temp (°F)</option>
        <option value="dew">Dewpoint (°F)</option>
        <option value="qpf">QPF (in)</option>
        <option value="snow">Snow (in)</option>
        <option value="wgust">Wind Gust (mph)</option>
      </select>

      <button onclick="loadProduct()">Reload</button>
    </div>

    <div class="slider-row">
      <button class="arrow" onclick="prevFrame()">◀</button>

      <span id="periodLabel">Day 1</span>

      <input type="range" id="frameSlider" min="0" max="0" value="0" />

      <button class="arrow" onclick="nextFrame()">▶</button>
    </div>

    <div class="valid-label" id="validLabel"></div>

    <img id="forecastImg" src="" />

  </div>
</div>

<script>
let manifest = null;
let currentVar = "maxt";
let currentFrame = 0;
let preloadedImages = [];

/* ---------- PATH FIX (important) ---------- */
function frameUrl(frameFile) {
  if (!frameFile) return "";
  if (frameFile.startsWith("http")) return frameFile;
  if (frameFile.startsWith("maps/")) return frameFile;
  return `maps/${frameFile}`;
}

function latestUrl(varName) {
  return `maps/latest_${varName}_ndfd.png`;
}

/* ---------- LOAD PRODUCT ---------- */
async function loadProduct() {
  currentVar = document.getElementById("varSelect").value;

  try {
    const res = await fetch(`maps/manifest_${currentVar}.json`);
    manifest = await res.json();

    setupSlider();
    preloadFrames();
    showFrame(0);

  } catch (err) {
    console.warn("Manifest failed, using latest image fallback.");
    manifest = null;
    document.getElementById("forecastImg").src = latestUrl(currentVar);
    document.getElementById("validLabel").innerText = "";
  }
}

/* ---------- SETUP SLIDER ---------- */
function setupSlider() {
  const slider = document.getElementById("frameSlider");

  slider.max = manifest.frame_count - 1;
  slider.value = 0;

  slider.oninput = (e) => {
    showFrame(parseInt(e.target.value));
  };
}

/* ---------- PRELOAD (FASTER SWITCHING) ---------- */
function preloadFrames() {
  preloadedImages = [];

  manifest.frames.forEach(frame => {
    const img = new Image();
    img.src = frameUrl(frame.file);
    preloadedImages.push(img);
  });
}

/* ---------- SHOW FRAME ---------- */
function showFrame(idx) {
  currentFrame = idx;

  const frame = manifest.frames[idx];

  document.getElementById("forecastImg").src = frameUrl(frame.file);
  document.getElementById("validLabel").innerText = frame.valid_local;

  document.getElementById("periodLabel").innerText =
    `Day ${idx + 1}`;

  document.getElementById("frameSlider").value = idx;
}

/* ---------- ARROWS ---------- */
function nextFrame() {
  if (!manifest) return;

  if (currentFrame < manifest.frame_count - 1) {
    showFrame(currentFrame + 1);
  }
}

function prevFrame() {
  if (!manifest) return;

  if (currentFrame > 0) {
    showFrame(currentFrame - 1);
  }
}

/* ---------- INIT ---------- */
window.onload = loadProduct;
</script>

</body>
</html>
