<!-- forecasts.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WxLaunch | Forecasts</title>

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.10);
      --accent:#6aa7ff;
      --good:#63ffcf;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(106,167,255,.18), transparent 60%),
                  radial-gradient(1000px 500px at 80% 10%, rgba(99,255,207,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow:hidden; /* one-screen, no page scroll */
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px}

    header{
      position:sticky;top:0;z-index:50;
      border-bottom:1px solid var(--line);
      background: rgba(11,16,32,.82);
      backdrop-filter: blur(10px);
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 0;
      gap:12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;letter-spacing:.3px;
      line-height:1;
    }
    .logo{
      width:28px;height:28px;border-radius:9px;
      background: linear-gradient(135deg, rgba(106,167,255,.9), rgba(99,255,207,.7));
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand small{
      display:block;
      margin-top:4px;
      font-weight:700;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.2px;
    }
    nav{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      font-weight:700;color:var(--muted);
    }
    nav a{padding:7px 9px;border-radius:10px}
    nav a.active{
      background: rgba(106,167,255,.14);
      color: var(--text);
      border:1px solid rgba(106,167,255,.22);
    }
    nav a:hover{color:var(--text)}

    main{ height: calc(100vh - 56px); }
    .panel{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:14px 0;
    }

    .card{
      height:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(18,26,51,.45);
      flex: 0 0 auto;
    }
    .cardHead h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .sub{ font-size:13px;color:var(--muted);margin:6px 0 0; }
    .pill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:6px 10px;border-radius:999px;
      color: var(--muted);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    .viewerArea{
      padding:10px 14px 14px;
      background: rgba(0,0,0,.06);
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* ===== TOP CONTROLS (buttons + zoom) ===== */
    .topControls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .leftControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
    }
    .label{
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Pill variable buttons */
    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .chip{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip:hover{ border-color: rgba(106,167,255,.35); }
    .chip[aria-pressed="true"]{
      background: rgba(106,167,255,.18);
      border-color: rgba(106,167,255,.42);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .chip .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.35);
      flex:0 0 auto;
    }
    .chip[aria-pressed="true"] .dot{
      background: rgba(99,255,207,.90);
    }

    .zoomControls{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      color: var(--muted);
      font-weight:850;
      font-size:12px;
      justify-content:flex-end;
    }

    button{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      outline:none;
    }
    button:hover{border-color: rgba(106,167,255,.35)}
    button:disabled{ opacity:.55; cursor:not-allowed; }

    /* ===== SLIDER ROW MOVED TO TOP ===== */
    .controlsTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(15,23,48,.35);
      flex: 0 0 auto;
      flex-wrap:wrap;
    }
    .sliderRow{
      display:flex;align-items:center;gap:10px;
      width:100%;
      flex-wrap:wrap;
    }
    .arrowBtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:44px;height:36px;padding:0;border-radius:12px;
      user-select:none;
    }
    .arrowBtn svg{width:18px;height:18px;opacity:.95}

    input[type="range"]{
      width: min(820px, 100%);
      accent-color: var(--accent);
    }

    .periodLabel{
      font-weight:950;
      min-width:140px;
      color: var(--text);
    }

    /* ===== Forecast zoom viewer ===== */
    #forecastViewer{
      width: 100%;
      height: clamp(520px, calc(100vh - 260px), 820px);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.20);
      background: #ffffff;
      overflow: hidden;
      position: relative;
      flex: 1 1 auto;
      min-height: 0;
    }
    #viewerStage{
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: #ffffff;
      cursor: grab;
    }
    #viewerStage.dragging{ cursor: grabbing; }

    #forecastImg{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:block;
      transform-origin: 0 0;
      will-change: transform;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    .viewer-overlay{
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color: rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 5;
    }
    .viewer-overlay.show{ opacity: 1; }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            WxLaunch
            <small>Government data only • NWS / NOAA</small>
          </div>
        </div>

        <nav aria-label="Primary navigation">
          <a href="index.html">Home</a>
          <a href="basics.html">Basics</a>
          <a href="winter.html">Winter</a>
          <a href="tropical.html">Tropical</a>
          <a href="severe.html">Severe</a>
          <a class="active" href="forecasts.html">Forecasts</a>
          <a href="soundings.html">Soundings</a>
          <a href="models.html">Models</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <section class="card" aria-label="Forecast viewer">
        <div class="cardHead">
          <div>
            <h1 id="forecastTitle">Forecast Viewer</h1>
            <div class="sub" id="forecastSubtitle">NWS/NDFD</div>
          </div>
          <div class="pill" id="generatedAtPill">Updated: —</div>
        </div>

        <div class="viewerArea">
          <!-- TOP: variable buttons + zoom tools -->
          <div class="topControls">
            <div class="leftControls">
              <span class="label">Variables</span>
              <div class="pillRow" id="pillRow" aria-label="Variable toggles"></div>
            </div>

            <div class="zoomControls">
              <button id="zoomOutBtn" type="button" title="Zoom out">−</button>
              <button id="zoomInBtn" type="button" title="Zoom in">+</button>
              <button id="resetViewBtn" type="button" title="Reset view">Reset</button>
              <span>Wheel to zoom • Drag to pan</span>
            </div>
          </div>

          <!-- TOP: slider moved above the map -->
          <div class="controlsTop" aria-label="Timeline controls">
            <div class="sliderRow">
              <button class="arrowBtn" id="prevBtn" type="button" aria-label="Previous">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="periodLabel" id="periodLabel">Period —</div>

              <input type="range" id="forecastSlider" min="0" max="0" step="1" value="0" />

              <button class="arrowBtn" id="nextBtn" type="button" aria-label="Next">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="pill" id="validLocalPill">Valid: —</div>
            </div>
          </div>

          <!-- MAP (Zoom Viewer) -->
          <div id="forecastViewer">
            <div class="viewer-overlay" id="viewerOverlay">Loading…</div>
            <div id="viewerStage">
              <img id="forecastImg" src="maps/latest_maxt_ndfd.png" alt="Forecast map" />
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ----------------------------
    // Manifest-based forecast loader
    // - Single-pane (old format)
    // - Variable selection via pill buttons (no dropdown)
    // - Slider moved to TOP
    // - Zoom/pan inside map viewer
    // - Reset zoom on variable OR frame change
    // - Instant switching (no reload button needed)
    // ----------------------------

    const VARS = [
      { key:"maxt",  label:"Max Temp (°F)" },
      { key:"mint",  label:"Min Temp (°F)" },
      { key:"dew",   label:"Dewpoint (°F)" },
      { key:"qpf",   label:"QPF (in)" },
      { key:"snow",  label:"Snow (in)" },
      { key:"wgust", label:"Wind Gust (mph)" },
    ];

    const els = {
      pillRow: document.getElementById("pillRow"),
      title: document.getElementById("forecastTitle"),
      subtitle: document.getElementById("forecastSubtitle"),
      updated: document.getElementById("generatedAtPill"),

      slider: document.getElementById("forecastSlider"),
      periodLabel: document.getElementById("periodLabel"),
      validPill: document.getElementById("validLocalPill"),
      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),

      stage: document.getElementById("viewerStage"),
      img: document.getElementById("forecastImg"),
      overlay: document.getElementById("viewerOverlay"),
      zoomIn: document.getElementById("zoomInBtn"),
      zoomOut: document.getElementById("zoomOutBtn"),
      resetView: document.getElementById("resetViewBtn"),
    };

    let selectedVar = "maxt";
    let manifest = null;
    let cacheKey = "";
    const preloaded = new Map(); // url -> HTMLImageElement

    // ===== Viewer state (translate + scale on the IMG) =====
    const viewer = {
      scale: 1,
      minScale: 1,
      maxScale: 5,
      x: 0,
      y: 0,
      dragging: false,
      dragStartX: 0,
      dragStartY: 0,
      startX: 0,
      startY: 0,
    };

    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

    function setLoading(on){
      els.overlay.classList.toggle("show", !!on);
    }

    function applyTransform(){
      els.img.style.transform = `translate(${viewer.x}px, ${viewer.y}px) scale(${viewer.scale})`;
    }

    function resetView(){
      viewer.scale = 1;
      viewer.x = 0;
      viewer.y = 0;
      applyTransform();
    }

    function zoomAt(newScale, clientX, clientY){
      const prev = viewer.scale;
      viewer.scale = clamp(newScale, viewer.minScale, viewer.maxScale);

      const rect = els.stage.getBoundingClientRect();
      const px = clientX - rect.left;
      const py = clientY - rect.top;

      const wx = (px - viewer.x) / prev;
      const wy = (py - viewer.y) / prev;

      viewer.x = px - wx * viewer.scale;
      viewer.y = py - wy * viewer.scale;

      applyTransform();
    }

    // Wheel zoom
    els.stage.addEventListener("wheel", (e) => {
      e.preventDefault();
      const step = (e.deltaY < 0) ? 0.18 : -0.18;
      zoomAt(viewer.scale + step, e.clientX, e.clientY);
    }, { passive:false });

    // Drag pan
    els.stage.addEventListener("mousedown", (e) => {
      viewer.dragging = true;
      els.stage.classList.add("dragging");
      viewer.dragStartX = e.clientX;
      viewer.dragStartY = e.clientY;
      viewer.startX = viewer.x;
      viewer.startY = viewer.y;
    });

    window.addEventListener("mouseup", () => {
      viewer.dragging = false;
      els.stage.classList.remove("dragging");
    });

    window.addEventListener("mousemove", (e) => {
      if (!viewer.dragging) return;
      const dx = e.clientX - viewer.dragStartX;
      const dy = e.clientY - viewer.dragStartY;
      viewer.x = viewer.startX + dx;
      viewer.y = viewer.startY + dy;
      applyTransform();
    });

    // Buttons
    els.zoomIn.addEventListener("click", () => {
      const r = els.stage.getBoundingClientRect();
      zoomAt(viewer.scale + 0.35, r.left + r.width/2, r.top + r.height/2);
    });
    els.zoomOut.addEventListener("click", () => {
      const r = els.stage.getBoundingClientRect();
      zoomAt(viewer.scale - 0.35, r.left + r.width/2, r.top + r.height/2);
    });
    els.resetView.addEventListener("click", resetView);

    // ---- URL helpers ----
    function manifestUrl(varName){ return `maps/manifest_${varName}.json`; }
    function frameUrl(file){ return file.startsWith("maps/") ? file : `maps/${file}`; }

    function withCacheKey(url){
      if (!cacheKey) return url;
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "v=" + encodeURIComponent(cacheKey);
    }

    async function fetchJson(url){
      const r = await fetch(withCacheKey(url));
      if (!r.ok) throw new Error(`Fetch failed ${r.status}`);
      return await r.json();
    }

    function setEnabled(enabled){
      els.slider.disabled = !enabled;
      els.prevBtn.disabled = !enabled;
      els.nextBtn.disabled = !enabled;
    }

    function updateButtons(){
      const n = manifest?.frames?.length || 0;
      const i = Number(els.slider.value || 0);
      els.prevBtn.disabled = !n || i <= 0;
      els.nextBtn.disabled = !n || i >= n - 1;
    }

    // ---- Image loading + preload for speed ----
    function preload(url){
      if (preloaded.has(url)) return;
      const im = new Image();
      im.src = url;
      preloaded.set(url, im);
    }

    async function setForecastImage(url){
      resetView(); // ✅ reset zoom on frame/variable change
      setLoading(true);

      els.img.src = url;

      try{
        if (els.img.decode) await els.img.decode();
      }catch(_){}

      setLoading(false);
    }

    function frameLabelFor(varName, idx){
      // keep it simple / consistent
      return `Day ${idx + 1} of ${(manifest?.frames?.length || 0) || 1}`;
    }

    function primePreloadAround(i){
      const frames = manifest?.frames || [];
      const next = frames[i + 1]?.file;
      const prev = frames[i - 1]?.file;
      if (next) preload(withCacheKey(frameUrl(next)));
      if (prev) preload(withCacheKey(frameUrl(prev)));
    }

    async function showFrame(idx){
      if (!manifest?.frames?.length) return;

      const frames = manifest.frames;
      const i = clamp(Number(idx), 0, frames.length - 1);
      els.slider.value = i;

      const fr = frames[i];
      els.validPill.textContent = `Valid: ${fr.valid_local || fr.valid_utc || "—"}`;
      els.periodLabel.textContent = frameLabelFor(selectedVar, i);

      const url = withCacheKey(frameUrl(fr.file));
      await setForecastImage(url);

      updateButtons();
      primePreloadAround(i);
    }

    async function loadVariable(varName){
      selectedVar = varName;
      setLoading(true);
      setEnabled(false);

      try{
        const m = await fetchJson(manifestUrl(varName));
        manifest = m;

        // cache key helps force fresh frames after updates
        cacheKey = m.ndfd_last_modified || m.generated_at_utc || "";

        els.title.textContent = m.title || "Forecast Viewer";
        els.subtitle.textContent = m.units ? `${m.var || varName} • ${m.units}` : `${m.var || varName}`;
        els.updated.textContent = `Updated: ${m.generated_at_utc || "—"}`;

        const n = Number(m.frame_count || (m.frames?.length || 0));
        els.slider.min = 0;
        els.slider.max = Math.max(0, n - 1);
        els.slider.value = 0;

        (m.frames || []).slice(0, 3).forEach(fr => preload(withCacheKey(frameUrl(fr.file))));

        setEnabled(true);
        await showFrame(0);
      } catch (_e){
        // Fallback if manifest missing
        manifest = null;
        els.title.textContent = "Forecast Viewer";
        els.subtitle.textContent = `${varName} • (no manifest yet)`;
        els.updated.textContent = "Updated: —";
        els.validPill.textContent = "Valid: —";
        els.periodLabel.textContent = "Period —";
        els.slider.min = 0; els.slider.max = 0; els.slider.value = 0;
        setEnabled(false);

        await setForecastImage(withCacheKey(`maps/latest_${varName}_ndfd.png`));
      } finally {
        setLoading(false);
      }
    }

    // ---- Variable pill UI ----
    function renderVarPills(){
      els.pillRow.innerHTML = "";
      for (const v of VARS){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip";
        b.dataset.key = v.key;
        b.setAttribute("aria-pressed", v.key === selectedVar ? "true" : "false");
        b.innerHTML = `<span class="dot" aria-hidden="true"></span><span>${v.label}</span>`;
        b.addEventListener("click", () => {
          if (selectedVar === v.key) return;
          setActivePill(v.key);
          loadVariable(v.key); // ✅ instant switch
        });
        els.pillRow.appendChild(b);
      }
    }

    function setActivePill(key){
      [...els.pillRow.querySelectorAll(".chip")].forEach(btn => {
        btn.setAttribute("aria-pressed", btn.dataset.key === key ? "true" : "false");
      });
    }

    // ---- Events ----
    els.slider.addEventListener("input", (e) => showFrame(e.target.value));
    els.prevBtn.addEventListener("click", () => showFrame(Number(els.slider.value) - 1));
    els.nextBtn.addEventListener("click", () => showFrame(Number(els.slider.value) + 1));

    // Init
    renderVarPills();
    loadVariable(selectedVar);
  </script>
</body>
</html>
