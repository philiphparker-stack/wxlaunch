<!-- forecasts.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WxLaunch | Forecasts</title>

  <style>
    :root{
      --bg:#0b1020;
      --text:#eaf0ff;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.10);
      --accent:#6aa7ff;
      --good:#63ffcf;

      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.20);
      --glass2: rgba(15,23,48,.45);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:16px;
      font-family: Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(40, 110, 160, 0.35), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(20, 80, 140, 0.25), transparent 55%),
        linear-gradient(135deg, #050714 0%, #0a1026 45%, #0b1f3a 100%);
      color: var(--text);
      overflow:hidden;
    }

    a{color:inherit;text-decoration:none}

    .wrap{
      width:100%;
      max-width:1200px;
      margin:0 auto;
    }

    /* ===== INDEX-STYLE HEADER ===== */
    .header-glass{
      padding: 18px 20px;
      border-radius: 14px;
      background: linear-gradient(
        180deg,
        rgba(20, 90, 150, 0.45),
        rgba(10, 45, 85, 0.35)
      );
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow:
        0 10px 30px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      margin-bottom: 12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      width: 100%;
      max-width: 380px;
      flex: 0 0 auto;
    }
    .logo-wrap img{
      width:100%;
      height:auto;
      display:block;
    }

    /* One-line tabs: second group to the right */
    .tabs{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:12px;
      flex-wrap:wrap;
      flex: 1 1 auto;
      min-width: 320px;
    }

    .tab-group{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      align-items:center;
    }

    .tab-divider-inline{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.55);
      white-space: nowrap;
      padding: 0 6px;
    }

    .tab{
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(13, 91, 120, 0.65);
      color: #ffffff;
      font-weight: 700;
      padding: 8px 16px;
      cursor: pointer;
      line-height: 1;
      appearance: none;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display:inline-flex;
      align-items:center;
      border-radius: 0; /* matches your index look */
    }

    .tab:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      transition: 0.12s ease;
    }

    .tab.active{
      background: rgba(255,255,255,0.95);
      color: #0b1f3a;
      border-color: rgba(255,255,255,0.85);
    }

    /* ===== MAIN LAYOUT ===== */
    main{
      flex:1 1 auto;
      min-height:0;
    }

    .panel{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      height:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(18,26,51,.45);
      flex: 0 0 auto;
      min-width:0;
    }
    .headLeft{min-width:0;}
    .cardHead h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:min(980px, 72vw);
    }

    .pill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:6px 10px;border-radius:999px;
      color: var(--muted);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .viewerArea{
      padding:10px 14px 12px;
      background: rgba(0,0,0,.06);
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Variables row */
    .topControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .label{
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
    }
    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .chip{
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:6px 10px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip:hover{ border-color: rgba(106,167,255,.35); }
    .chip[aria-pressed="true"]{
      background: rgba(106,167,255,.18);
      border-color: rgba(106,167,255,.42);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }
    .chip .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.35);
      flex:0 0 auto;
    }
    .chip[aria-pressed="true"] .dot{ background: rgba(99,255,207,.92); }

    /* Timeline bar */
    .timelineBar{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: var(--glass2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 14px 36px rgba(0,0,0,.28);
      flex: 0 0 auto;
    }
    .sliderRow{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      flex-wrap:wrap;
    }
    .arrowBtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:34px;height:28px;padding:0;border-radius:12px;
      user-select:none;
      flex: 0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
    }
    .arrowBtn:hover{ border-color: rgba(106,167,255,.35); }
    .arrowBtn:disabled{ opacity:.55; cursor:not-allowed; }
    .arrowBtn svg{width:18px;height:18px;opacity:.95}

    .periodLabel{
      font-weight:950;
      min-width:95px;
      color: var(--text);
      font-size:13px;
      flex: 0 0 auto;
    }
    input[type="range"]{
      width: min(920px, 100%);
      accent-color: var(--accent);
      flex: 1 1 auto;
      min-width: 240px;
    }
    .pillMini{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:4px 8px;
      border-radius:999px;
      color: var(--text);
      font-weight:900;
      font-size:11px;
      white-space:nowrap;
      flex: 0 0 auto;
    }

    /* Map viewer */
    #forecastViewer{
      width:100%;
      flex: 1 1 auto;
      min-height: 0;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: var(--bg);
      overflow:hidden;
      position:relative;
    }
    #viewerStage{
      position:absolute;
      inset:0;
      overflow:hidden;
      background: var(--bg);
      cursor:grab;
    }
    #viewerStage.dragging{ cursor:grabbing; }

    #forecastImg{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      transform-origin: 0 0;
      will-change: transform;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .viewer-overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      color: rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.26);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index:30;
    }
    .viewer-overlay.show{ opacity:1; }

    /* Zoom controls on map */
    .mapTools{
      position:absolute;
      top:10px;
      left:10px;
      z-index:25;
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:14px;
      background: rgba(11,16,32,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 34px rgba(0,0,0,.30);
    }
    .toolBtn{
      width:34px;height:30px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:950;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .toolBtn:hover{ border-color: rgba(106,167,255,.35); }
    .toolReset{
      padding:0 10px;
      height:30px;
      width:auto;
      border-radius:12px;
    }
    .toolHint{
      color: var(--muted);
      font-weight:850;
      font-size:12px;
      white-space:nowrap;
      margin-left:4px;
    }

    @media (max-width: 980px){
      .logo-wrap{ max-width: 320px; }
      .tabs{ justify-content:flex-start; }
      .tab-divider-inline{ width:100%; padding: 0; }
      .toolHint{ display:none; }
      input[type="range"]{ min-width: 200px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header-glass">
      <div class="topbar">
        <div class="logo-wrap">
          <img src="wxlaunch-logo.png" alt="WXLaunch Logo">
        </div>

        <!-- Same header style as index, but as page links -->
        <div class="tabs" aria-label="Primary navigation">
          <div class="tab-group">
            <a class="tab" href="basics.html">Basics</a>
            <a class="tab" href="severe.html">Severe Weather</a>
            <a class="tab" href="tropical.html">Tropical Weather</a>
            <a class="tab" href="winter.html">Winter Weather</a>
          </div>

          <div class="tab-divider-inline">Analysis &amp; Guidance</div>

          <div class="tab-group">
            <a class="tab active" href="forecasts.html" aria-current="page">Forecasts</a>
            <a class="tab" href="models.html">Models</a>
            <a class="tab" href="soundings.html">Soundings</a>
            <a class="tab" href="satellite.html">Satellite</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="panel">
      <section class="card" aria-label="Forecast viewer">
        <div class="cardHead">
          <div class="headLeft">
            <h1 id="forecastTitle">Forecast Viewer</h1>
          </div>
          <div class="pill" id="generatedAtPill">Updated: —</div>
        </div>

        <div class="viewerArea">
          <div class="topControls">
            <span class="label">Variables</span>
            <div class="pillRow" id="pillRow" aria-label="Variable toggles"></div>
          </div>

          <div class="timelineBar" aria-label="Timeline controls">
            <div class="sliderRow">
              <button class="arrowBtn" id="prevBtn" type="button" aria-label="Previous">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="periodLabel" id="periodLabel">Day —</div>
              <input type="range" id="forecastSlider" min="0" max="0" step="1" value="0" />

              <button class="arrowBtn" id="nextBtn" type="button" aria-label="Next">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="pillMini" id="validLocalPill">Valid: —</div>
            </div>
          </div>

          <div id="forecastViewer">
            <div class="viewer-overlay" id="viewerOverlay">Loading…</div>

            <div class="mapTools" aria-label="Map tools">
              <button class="toolBtn" id="zoomOutBtn" type="button" title="Zoom out">−</button>
              <button class="toolBtn" id="zoomInBtn" type="button" title="Zoom in">+</button>
              <button class="toolBtn toolReset" id="resetViewBtn" type="button" title="Reset view">Reset</button>
              <span class="toolHint">Wheel to zoom • Drag to pan</span>
            </div>

            <div id="viewerStage">
              <img id="forecastImg" src="maps/latest_maxt_ndfd.png" alt="Forecast map" />
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const VARS = [
      { key:"maxt",  label:"Max Temp (°F)" },
      { key:"mint",  label:"Min Temp (°F)" },
      { key:"dew",   label:"Dewpoint (°F)" },
      { key:"qpf",   label:"QPF (in)" },
      { key:"snow",  label:"Snow (in)" },
      { key:"wgust", label:"Wind Gust (mph)" },
    ];

    const els = {
      pillRow: document.getElementById("pillRow"),
      title: document.getElementById("forecastTitle"),
      updated: document.getElementById("generatedAtPill"),

      slider: document.getElementById("forecastSlider"),
      periodLabel: document.getElementById("periodLabel"),
      validPill: document.getElementById("validLocalPill"),
      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),

      stage: document.getElementById("viewerStage"),
      img: document.getElementById("forecastImg"),
      overlay: document.getElementById("viewerOverlay"),

      zoomIn: document.getElementById("zoomInBtn"),
      zoomOut: document.getElementById("zoomOutBtn"),
      resetView: document.getElementById("resetViewBtn"),
    };

    let selectedVar = "maxt";
    let manifest = null;
    let cacheKey = "";
    const preloaded = new Map();

    const viewer = {
      scale: 1,
      minScale: 1,
      maxScale: 5,
      x: 0,
      y: 0,
      dragging: false,
      dragStartX: 0,
      dragStartY: 0,
      startX: 0,
      startY: 0,
    };

    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
    function setLoading(on){ els.overlay.classList.toggle("show", !!on); }
    function applyTransform(){
      els.img.style.transform = `translate(${viewer.x}px, ${viewer.y}px) scale(${viewer.scale})`;
    }
    function resetView(){
      viewer.scale = 1; viewer.x = 0; viewer.y = 0;
      applyTransform();
    }

    function zoomAt(newScale, clientX, clientY){
      const prev = viewer.scale;
      viewer.scale = clamp(newScale, viewer.minScale, viewer.maxScale);

      const rect = els.stage.getBoundingClientRect();
      const px = clientX - rect.left;
      const py = clientY - rect.top;

      const wx = (px - viewer.x) / prev;
      const wy = (py - viewer.y) / prev;

      viewer.x = px - wx * viewer.scale;
      viewer.y = py - wy * viewer.scale;
      applyTransform();
    }

    els.stage.addEventListener("wheel", (e) => {
      e.preventDefault();
      const step = (e.deltaY < 0) ? 0.18 : -0.18;
      zoomAt(viewer.scale + step, e.clientX, e.clientY);
    }, { passive:false });

    els.stage.addEventListener("mousedown", (e) => {
      viewer.dragging = true;
      els.stage.classList.add("dragging");
      viewer.dragStartX = e.clientX;
      viewer.dragStartY = e.clientY;
      viewer.startX = viewer.x;
      viewer.startY = viewer.y;
    });

    window.addEventListener("mouseup", () => {
      viewer.dragging = false;
      els.stage.classList.remove("dragging");
    });

    window.addEventListener("mousemove", (e) => {
      if (!viewer.dragging) return;
      viewer.x = viewer.startX + (e.clientX - viewer.dragStartX);
      viewer.y = viewer.startY + (e.clientY - viewer.dragStartY);
      applyTransform();
    });

    els.zoomIn.addEventListener("click", () => {
      const r = els.stage.getBoundingClientRect();
      zoomAt(viewer.scale + 0.35, r.left + r.width/2, r.top + r.height/2);
    });
    els.zoomOut.addEventListener("click", () => {
      const r = els.stage.getBoundingClientRect();
      zoomAt(viewer.scale - 0.35, r.left + r.width/2, r.top + r.height/2);
    });
    els.resetView.addEventListener("click", resetView);

    function manifestUrl(varName){ return `maps/manifest_${varName}.json`; }
    function frameUrl(file){ return file.startsWith("maps/") ? file : `maps/${file}`; }
    function withCacheKey(url){
      if (!cacheKey) return url;
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "v=" + encodeURIComponent(cacheKey);
    }

    async function fetchJson(url){
      const r = await fetch(withCacheKey(url));
      if (!r.ok) throw new Error(`Fetch failed ${r.status}`);
      return await r.json();
    }

    function setEnabled(enabled){
      els.slider.disabled = !enabled;
      els.prevBtn.disabled = !enabled;
      els.nextBtn.disabled = !enabled;
    }

    function updateButtons(){
      const n = manifest?.frames?.length || 0;
      const i = Number(els.slider.value || 0);
      els.prevBtn.disabled = !n || i <= 0;
      els.nextBtn.disabled = !n || i >= n - 1;
    }

    function preload(url){
      if (preloaded.has(url)) return;
      const im = new Image();
      im.src = url;
      preloaded.set(url, im);
    }

    async function setForecastImage(url){
      setLoading(true);
      els.img.src = url;
      try{ if (els.img.decode) await els.img.decode(); }catch(_){}
      setLoading(false);
      applyTransform();
    }

    function frameLabel(idx, total){
      const n = Math.max(1, Number(total) || 1);
      return `Day ${idx + 1} of ${n}`;
    }

    function primePreloadAround(i){
      const frames = manifest?.frames || [];
      const next = frames[i + 1]?.file;
      const prev = frames[i - 1]?.file;
      if (next) preload(withCacheKey(frameUrl(next)));
      if (prev) preload(withCacheKey(frameUrl(prev)));
    }

    async function showFrame(idx){
      if (!manifest?.frames?.length) return;

      const frames = manifest.frames;
      const i = clamp(Number(idx), 0, frames.length - 1);
      els.slider.value = i;

      const fr = frames[i];
      els.validPill.textContent = `Valid: ${fr.valid_local || fr.valid_utc || "—"}`;
      els.periodLabel.textContent = frameLabel(i, frames.length);

      await setForecastImage(withCacheKey(frameUrl(fr.file)));
      updateButtons();
      primePreloadAround(i);
    }

    async function loadVariable(varName){
      selectedVar = varName;
      setLoading(true);
      setEnabled(false);

      try{
        const m = await fetchJson(manifestUrl(varName));
        manifest = m;

        cacheKey = m.ndfd_last_modified || m.generated_at_utc || "";
        els.title.textContent = m.title || "Forecast Viewer";
        els.updated.textContent = `Updated: ${m.generated_at_utc || "—"}`;

        const n = Number(m.frame_count || (m.frames?.length || 0));
        els.slider.min = 0;
        els.slider.max = Math.max(0, n - 1);
        els.slider.value = 0;

        (m.frames || []).slice(0, 3).forEach(fr => fr?.file && preload(withCacheKey(frameUrl(fr.file))));

        setEnabled(true);
        await showFrame(0);
      } catch (_e){
        manifest = null;
        els.title.textContent = "Forecast Viewer";
        els.updated.textContent = "Updated: —";
        els.validPill.textContent = "Valid: —";
        els.periodLabel.textContent = "Day —";
        els.slider.min = 0; els.slider.max = 0; els.slider.value = 0;
        setEnabled(false);

        await setForecastImage(withCacheKey(`maps/latest_${varName}_ndfd.png`));
      } finally {
        setLoading(false);
      }
    }

    function renderVarPills(){
      els.pillRow.innerHTML = "";
      for (const v of VARS){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip";
        b.dataset.key = v.key;
        b.setAttribute("aria-pressed", v.key === selectedVar ? "true" : "false");
        b.innerHTML = `<span class="dot" aria-hidden="true"></span><span>${v.label}</span>`;
        b.addEventListener("click", () => {
          if (selectedVar === v.key) return;
          setActivePill(v.key);
          loadVariable(v.key);
        });
        els.pillRow.appendChild(b);
      }
    }

    function setActivePill(key){
      [...els.pillRow.querySelectorAll(".chip")].forEach(btn => {
        btn.setAttribute("aria-pressed", btn.dataset.key === key ? "true" : "false");
      });
    }

    els.slider.addEventListener("input", (e) => showFrame(e.target.value));
    els.prevBtn.addEventListener("click", () => showFrame(Number(els.slider.value) - 1));
    els.nextBtn.addEventListener("click", () => showFrame(Number(els.slider.value) + 1));

    renderVarPills();
    loadVariable(selectedVar);
    applyTransform();
  </script>
</body>
</html>
